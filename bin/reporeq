#!/usr/bin/env bash
# reporeq - The simplest and last package manager you will ever use
# Usage: ./reporeq [requirements-file]

set -euo pipefail

# Parse a line into url and ref
# Usage: parse_line "https://github.com/user/repo@v1.0.0"
# Sets: PARSE_URL, PARSE_REF
parse_line() {
    local line="$1"
    PARSE_URL="$line"
    PARSE_REF=""

    if [[ "$line" == *@* ]]; then
        PARSE_URL="${line%@*}"
        PARSE_REF="${line##*@}"
        # SSH URLs contain : in the host part, reset if ref has :
        if [[ "$PARSE_REF" == *:* ]]; then
            PARSE_URL="$line"
            PARSE_REF=""
        fi
    fi
}

# Allow sourcing for testing
if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
    return 0
fi

readonly REQUIREMENTS_FILE="${1:-reporeq.txt}"
readonly INSTALL_DIR=".reporeq"

if [[ ! -f "$REQUIREMENTS_FILE" ]]; then
    echo "Error: Requirements file '$REQUIREMENTS_FILE' not found" >&2
    exit 1
fi

readonly TEMP_DIR="$(mktemp -d -p .)"

mkdir -p "$TEMP_DIR/bin"

while IFS= read -r line || [[ -n "$line" ]]; do
    line="${line%$'\r'}"
    [[ -z "$line" || "$line" == \#* ]] && continue

    parse_line "$line"
    url="$PARSE_URL"
    ref="$PARSE_REF"

    repo_name="$(basename "$url" .git)"
    dest="$TEMP_DIR/$repo_name"

    rm -rf "$dest"

    if [[ -z "$ref" ]]; then
        echo ":: $repo_name @ HEAD"
        if ! git clone --quiet --depth 1 "$url" "$dest"; then
            echo "Error: Failed to clone $url" >&2
            rm -rf "$TEMP_DIR"
            exit 1
        fi
    else
        echo ":: $repo_name @ $ref"
        if ! git clone --quiet "$url" "$dest"; then
            echo "Error: Failed to clone $url" >&2
            rm -rf "$TEMP_DIR"
            exit 1
        fi
        if ! git -C "$dest" checkout --quiet "$ref"; then
            echo "Error: Failed to checkout $ref for $repo_name" >&2
            rm -rf "$TEMP_DIR"
            exit 1
        fi
    fi

    if [[ -d "$dest/bin" ]]; then
        for exe in "$dest/bin"/*; do
            if [[ -x "$exe" && -f "$exe" ]]; then
                ln -sf "../$repo_name/bin/$(basename "$exe")" "$TEMP_DIR/bin/$(basename "$exe")"
            fi
        done
    fi
done < "$REQUIREMENTS_FILE"

rm -rf "$INSTALL_DIR"
mv "$TEMP_DIR" "$INSTALL_DIR"

echo ":: Done. PATH: export PATH=\"\$PWD/$INSTALL_DIR/bin:\$PATH\""
