#!/bin/bash
# reporeq - The simplest and last package manager you will ever use
# Usage: ./reporeq [reporeq.txt]

set -euo pipefail

readonly REQS="${1:-reporeq.txt}"
readonly DEST=".reporeq"
readonly TMP="$(mktemp -d -p .)"

if [[ ! -f "$REQS" ]]; then
    echo "Error: $REQS not found" >&2
    exit 1
fi

mkdir -p "$TMP/bin"

while IFS= read -r line || [[ -n "$line" ]]; do
    line="${line%$'\r'}"
    [[ -z "$line" || "$line" == \#* ]] && continue

    url="$line"
    tag="$line"

    if [[ "$line" == *@* ]]; then
        url="${line%@*}"
        tag="${line##*@}"
        if [[ "$tag" == */* || "$tag" == *:* ]]; then
            url="$line"
            tag="$line"
        fi
    fi

    name=$(basename "${url%.git}")
    rm -rf "${TMP:?}/$name"

    if [[ "$url" == "$tag" ]]; then
        echo ":: $name @ HEAD"
        git clone -q "$url" "$TMP/$name" || exit 1
    else
        echo ":: $name @ $tag"
        git clone -q "$url" "$TMP/$name" || exit 1
        git -C "$TMP/$name" checkout -q "$tag" || exit 1
    fi

    if [[ -d "$TMP/$name/bin" ]]; then
        for f in "$TMP/$name/bin"/*; do
            [[ -x "$f" && -f "$f" ]] || continue
            ln -sf "../${f#"$TMP/"}" "$TMP/bin/$(basename "$f")"
        done
    fi
done < "$REQS"

rm -rf "$DEST"
mv "$TMP" "$DEST"

echo ":: Done. PATH: export PATH=\"\$PWD/$DEST/bin:\$PATH\""
